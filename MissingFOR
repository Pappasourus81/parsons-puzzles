<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FOR Loops- Fill in the blanks</title>
<style>
  :root{
    --bg:#ffffff; --accent:#0066cc; --ok:#d4f7d9; --bad:#ffd6d6;
    --panel:#f8f9fb; --muted:#666; --token-border:#e0e6ef;
  }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; background:var(--bg); color:#111; }
  h1{ margin:0 0 12px 0; font-size:20px; }
  .meta{ color:#444; margin-bottom:12px; }
  .panel{ background:var(--panel); padding:12px; border-radius:10px; margin-bottom:12px; }
  .desc-box{ padding:10px; border-radius:8px; background:#fff; border:1px solid #d1d7df; margin-bottom:10px; white-space:normal; }
  .desc-bullets{ margin:6px 0 8px 18px; color:#222; }
  .hint{ margin-top:6px; font-style:italic; color:#374151; }
  .example-box{ margin-top:8px; padding:8px; background:#f7fbff; border:1px solid #d9eefc; border-radius:6px; font-family: "Courier New", monospace; color:#0b3b66; display:none; white-space:pre-line; }
  .teacher-controls{ margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .teacher-note{ margin-top:6px; color:#6b6b6b; font-size:13px; }
  .code-area{ font-family: "Courier New", monospace; background:#fff; padding:10px; border-radius:8px; border:1px dashed #ccc; min-height:140px; }
  .code-line{ padding:6px 4px; white-space:pre-wrap; }
  .blank{ display:inline-flex; align-items:center; justify-content:center; min-width:56px; padding:4px 8px; margin:0 4px; background:#f2f6fb; border-radius:4px; border:1px dashed #9fb8e6; cursor:pointer; outline:none; color:#111; font-weight:600; }
  .blank.filled{ background:#fff; border-style:solid; border-color:var(--token-border); }
  .blank.correct{ background:var(--ok); border-color:#2a9a4a; }
  .blank.incorrect{ background:var(--bad); border-color:#c44; }
  .bank{ display:flex; flex-wrap:wrap; gap:8px; padding:10px; margin-top:10px; background:transparent; }
  .token{ background:#fff; border:1px solid var(--token-border); padding:6px 10px; border-radius:8px; cursor:grab; user-select:none; display:inline-flex; align-items:center; justify-content:center; min-width:40px; color:#111; font-weight:600; }
  .token[aria-pressed="true"]{ outline:3px solid rgba(0,102,204,0.18); box-shadow:0 2px 6px rgba(0,0,0,0.06); }
  .controls{ display:flex; gap:8px; margin-top:12px; align-items:center; }
  button.action{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  button.secondary{ background:#666; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  button.small{ padding:6px 10px; font-size:13px; border-radius:6px; }
  #message{ margin-top:10px; font-weight:600; }
  .keyboard-hint{ color:var(--muted); font-size:13px; margin-top:6px; }
  @media (max-width:700px){ .bank{ gap:6px; } .blank{ min-width:44px; } .token{ min-width:32px; padding:6px 8px;} }
</style>
</head>
<body>
  <h1>FOR Loops- Fill in the blanks</h1>
  <div class="meta">Place the correct token into each blank. Use drag & drop, or keyboard: Tab to token â†’ Enter to pick â†’ Tab to blank â†’ Enter to place. Tokens remain available after use. Difficulty increases across puzzles â€” later puzzles have more blanks and distractors.</div>

  <div class="panel">
    <div id="desc" class="desc-box">
      <div id="descTitle" style="font-weight:700; margin-bottom:6px;">Select a puzzle to see its description</div>
      <ul id="descBullets" class="desc-bullets"></ul>
      <div id="teacherHint" class="hint"></div>
      <div class="teacher-controls">
        <button id="toggleExample" class="small">Show example output</button>
        <button id="revealHintBtn" class="small">Reveal hint (fill one blank)</button>
        <button id="teacherRevealAllBtn" class="small">Teacher: Reveal all answers</button>
        <button id="teacherLogoutBtn" class="small" style="display:none;">Teacher: Logout</button>
      </div>
      <div id="exampleBox" class="example-box" role="region" aria-hidden="true"></div>
      <div class="teacher-note" id="teacherNote">Teacher toggle is protected by a password saved in localStorage on this browser. This is a convenience only â€” localStorage is not strongly secure. Use a simple password and keep it safe.</div>
    </div>

    <div class="code-area" id="codeArea" aria-live="polite"></div>

    <div class="bank" id="bank" aria-label="token bank"></div>

    <div class="keyboard-hint">Tip: click a token to select it, then click a blank to place it. You can reuse tokens freely.</div>

    <div class="controls">
      <button id="submitBtn" class="action">Submit</button>
      <button id="resetBtn" class="secondary">Reset (reshuffle)</button>
      <button id="nextBtn" class="action">Next Puzzle</button>
      <div style="margin-left:auto;">
        <label style="font-size:13px;color:#333">Puzzle:
          <select id="puzzleSelect" style="margin-left:8px; padding:6px; border-radius:6px;"></select>
        </label>
      </div>
    </div>

    <div id="message" role="status"></div>
  </div>

<script>
/*
 Teacher "Reveal All" with simple password prompt stored in localStorage.
 - First-time use: set a password (confirmed).
 - Afterwards: enter password to authenticate.
 - If authentication succeeds, the Teacher: Reveal all answers button toggles to "Hide answers".
 - When revealing, the current blanks state is saved so it can be restored when hiding.
 - Note: localStorage is not secure; the feature is convenience for a teacher on a shared public page.
*/

const STORAGE_KEY = 'parsons_teacher_pw'; // stored password key (simple)
const puzzles = [
  {
    title: "Simple FOR output 1 to 3",
    bullets: ["No input â€” print numbers 1 to 3 using a FOR loop.", "Each number should appear on its own line."],
    hint: "Use a loop variable (i). OUTPUT i each iteration.",
    example: "1\n2\n3",
    lines: ["___1___ i = ___2___ TO ___3___ DO","OUTPUT ___4___","NEXT ___5___"],
    answers: ["FOR","1","3","i","i"],
    bank: ["FOR","NEXT","i","1","3","TO","OUTPUT","2"]
  },
  {
    title: "FOR with STEP 3",
    bullets: ["No input â€” output every third number from 1 up to 10.","Use STEP to change how much the loop increases each time."],
    hint: "Start at 1, end at 10, use STEP 3.",
    example: "1\n4\n7\n10",
    lines: ["___1___ i = ___2___ ___3___ ___4___ ___5___","OUTPUT i","NEXT i"],
    answers: ["FOR","1","TO","10","3"],
    bank: ["1","2","3","10","FOR","TO","STEP","OUTPUT","i","NEXT","4"]
  },
  {
    title: "Descending FOR loop",
    bullets: ["No input â€” count down from 5 to 1.","Use a negative STEP so the loop decreases."],
    hint: "Set STEP to -1 to decrement the loop variable.",
    example: "5\n4\n3\n2\n1",
    lines: ["___1___ k = ___2___ ___3___ ___4___ ___5___","OUTPUT k","NEXT k"],
    answers: ["FOR","5","TO","1","-1"],
    bank: ["FOR","k","5","1","-1","TO","STEP","OUTPUT","NEXT","i","0"]
  },
  {
    title: "Sum a few values",
    bullets: ["Input: prompt user for 3 numbers (one per iteration).","Add each number to a running total and print the total after the loop."],
    hint: "Initialise total to 0 before the loop and add each input to total.",
    example: "Input: 1, 2, 3  â†’ Output: 6",
    lines: ["___1___ = ___2___","___3___ ___4___ ___5___ ___6___ ___7___","INPUT ___8___","___9___ = ___9___ ___10___ ___8___","NEXT ___11___","OUTPUT ___9___"],
    answers: ["total","0","FOR","i","=","1","TO","n","total","+","i"],
    bank: ["total","sum","0","1","2","+","-","*","FOR","i","j","TO","STEP","OUTPUT","INPUT","n","=","NEXT"]
  },
  {
    title: "Double input values",
    bullets: ["Input: prompt the user 4 times for a number.","For each entered number, print twice its value."],
    hint: "Multiply the input by 2 before outputting.",
    example: "Input: 2 â†’ Output: 4",
    lines: ["___1___ ___2___ ___3___ ___4___","INPUT ___5___","OUTPUT ___5___ ___6___ ___7___","NEXT ___8___"],
    answers: ["FOR","i","=","1","value","*","2","i"],
    bank: ["FOR","i","=","1","4","2","*","/","+","INPUT","OUTPUT","value","NEXT"]
  },
  {
    title: "Output only even numbers",
    bullets: ["Input: prompt the user 4 times for a number.","Output the number only if it is even (divisible by 2)."],
    hint: "Use MOD to test remainder when dividing by 2.",
    example: "Input: 2,3,4,5 â†’ Output:\n2\n4",
    lines: ["___1___ i = ___2___ ___3___ ___4___","INPUT ___5___","IF ___5___ ___6___ ___7___ ___8___","OUTPUT ___5___","ENDIF","NEXT ___1___"],
    answers: ["FOR","1","TO","4","num","MOD","2","= 0"],
    bank: ["FOR","1","2","3","4","TO","STEP","MOD","%","=","= 0","num","n","INPUT","OUTPUT","IF","THEN","ENDIF","NEXT"]
  },
  {
    title: "Count values above threshold",
    bullets: ["Input: prompt the user 5 times for a number.","Count how many of the entered numbers are greater than 10 and print the count."],
    hint: "Initialise a counter at 0; when value > 10, increment the counter.",
    example: "Input: 12,9,15,6,11 â†’ Output: 3",
    lines: ["___1___ = ___2___","___3___ ___4___ ___5___ ___6___","INPUT ___7___","IF ___7___ ___8___ ___9___ ___10___","___1___ = ___1___ + 1","ENDIF","NEXT ___5___","OUTPUT ___1___"],
    answers: ["count","0","FOR","i","1","TO","v",">","10","THEN"],
    bank: ["count","cnt","0","1","5","10","TO","FOR","i","j","v","INPUT","OUTPUT",">","<","=","THEN","IF","NEXT","+","-"]
  },
  {
    title: "FOR with variable step expression",
    bullets: ["No input. Assign a variable stepSize (e.g. 2) and use it in the STEP clause of a FOR loop.","The loop should print values from 1 to 5 stepping by stepSize."],
    hint: "Declare stepSize, then use STEP stepSize in the FOR header.",
    example: "With stepSize = 2 â†’ Output:\n1\n3\n5",
    lines: ["___1___ = ___2___","___3___ ___4___ ___5___ ___6___ ___7___ ___8___","OUTPUT ___4___","NEXT ___4___"],
    answers: ["stepSize","2","FOR","i","=","1","TO","5"],
    bank: ["stepSize","step","2","1","5","FOR","i","j","=","TO","STEP","OUTPUT","NEXT","rand"]
  },
  {
    title: "NEXT variable mismatch (attention to names)",
    bullets: ["No input. Print the numbers 1 to 3 using a FOR loop.","Be careful that the variable name in NEXT matches the FOR variable."],
    hint: "If you use FOR index = 1 TO 3, then write NEXT index (not NEXT i).",
    example: "1\n2\n3",
    lines: ["___1___ ___2___ ___3___ ___4___ ___5___","OUTPUT ___2___","NEXT ___6___"],
    answers: ["FOR","index","=","1","3","index"],
    bank: ["FOR","index","i","=","1","3","NEXT","OUTPUT","TO","STEP","j"]
  },
  {
    title: "Nested FOR to build pairs (mostly blanks)",
    bullets: ["No input. Use nested FOR loops to produce ordered pairs (i, j): i from 1 to 2 and j from 1 to 3.","Print each pair (i, j) so that all six pairs are produced."],
    hint: "Outer loop: FOR i = 1 TO 2 DO; inner loop: FOR j = 1 TO 3 DO; OUTPUT i , j; NEXT j; NEXT i.",
    example: "1 , 1\n1 , 2\n1 , 3\n2 , 1\n2 , 2\n2 , 3",
    lines: ["___1___ ___2___ ___3___ ___4___ ___5___","___6___ ___7___ ___8___ ___9___ ___10___","___11___ ___12___ ___13___ ___14___ ___15___","___16___ ___17___ ___18___ ___19___ ___20___","___21___ ___22___ ___23___ ___24___ ___25___"],
    answers: ["FOR","i","=","1","TO","2","FOR","j","=","1","TO","3","DO","OUTPUT","i",",","j","NEXT","j","NEXT","i"],
    bank: ["FOR","NEXT","i","j","=","1","2","3","TO","STEP","DO","OUTPUT",",",";","INPUT","OUTPUT","FORWARD","END","NEXT i","NEXT j","rand","value","k","OUTPUT i","OUTPUT j"]
  }
];

// UI elements
const bankEl = document.getElementById('bank');
const codeArea = document.getElementById('codeArea');
const descTitle = document.getElementById('descTitle');
const descBullets = document.getElementById('descBullets');
const teacherHint = document.getElementById('teacherHint');
const toggleExample = document.getElementById('toggleExample');
const revealHintBtn = document.getElementById('revealHintBtn');
const teacherRevealAllBtn = document.getElementById('teacherRevealAllBtn');
const teacherLogoutBtn = document.getElementById('teacherLogoutBtn');
const exampleBox = document.getElementById('exampleBox');
const msgEl = document.getElementById('message');
const puzzleSelect = document.getElementById('puzzleSelect');

let currentIndex = 0;
let selectedToken = null;
let teacherAuthenticated = false;
const usedHintForPuzzle = {}; // one hint per puzzle
const prevStateForReveal = {}; // store previous blanks state to restore after hide

// --- utility ---
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
function populatePuzzleSelect(){
  puzzles.forEach((p,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${i+1}. ${p.title}`;
    puzzleSelect.appendChild(opt);
  });
}

// --- DESCRIPTION & EXAMPLE toggle ---
function renderDescription(p){
  descTitle.textContent = p.title || '';
  descBullets.innerHTML = '';
  (p.bullets || []).forEach(b => {
    const li = document.createElement('li');
    li.textContent = b;
    descBullets.appendChild(li);
  });
  teacherHint.textContent = p.hint || '';
  if(p.example && p.example.trim().length > 0){
    toggleExample.style.display = 'inline-block';
    exampleBox.textContent = p.example;
    exampleBox.style.display = 'none';
    exampleBox.setAttribute('aria-hidden','true');
    toggleExample.textContent = 'Show example output';
  } else {
    toggleExample.style.display = 'none';
    exampleBox.style.display = 'none';
    exampleBox.setAttribute('aria-hidden','true');
  }
  // teacher controls UI state
  updateTeacherButtons();
}

// --- example toggle ---
toggleExample.addEventListener('click', ()=>{
  const visible = exampleBox.style.display !== 'none';
  if(visible){
    exampleBox.style.display = 'none';
    exampleBox.setAttribute('aria-hidden','true');
    toggleExample.textContent = 'Show example output';
  } else {
    exampleBox.style.display = 'block';
    exampleBox.setAttribute('aria-hidden','false');
    toggleExample.textContent = 'Hide example output';
  }
});

// --- bank rendering ---
function renderBank(tokens){
  bankEl.innerHTML = '';
  const arr = tokens.slice();
  shuffleArray(arr);
  arr.forEach(tok=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'token';
    b.textContent = tok;
    b.setAttribute('aria-pressed','false');
    b.draggable = true;
    b.tabIndex = 0;
    b.addEventListener('click', ()=> toggleSelectToken(b, tok));
    b.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSelectToken(b,tok); }});
    b.addEventListener('dragstart', (e)=> e.dataTransfer.setData('text/plain', tok));
    bankEl.appendChild(b);
  });
}

// --- selection for tokens ---
function toggleSelectToken(el, val){
  if(selectedToken && selectedToken.el === el){
    el.setAttribute('aria-pressed','false'); selectedToken = null; return;
  }
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  el.setAttribute('aria-pressed','true');
  selectedToken = {el, val};
}

// --- render code area with blanks ---
function renderCode(puzzle){
  codeArea.innerHTML = '';
  puzzle.lines.forEach(line=>{
    const lineDiv = document.createElement('div');
    lineDiv.className = 'code-line';
    let last = 0;
    const re = /___(\d+)___/g;
    let m;
    while((m = re.exec(line)) !== null){
      const idx = m.index;
      const before = line.slice(last, idx);
      if(before) lineDiv.appendChild(document.createTextNode(before));
      const num = m[1];
      const span = document.createElement('button');
      span.type = 'button';
      span.className = 'blank';
      span.dataset.blank = num;
      span.dataset.filled = 'false';
      span.dataset.token = '';
      span.textContent = `___${num}___`;
      // drag drop
      span.addEventListener('dragover', e => { e.preventDefault(); span.classList.add('dragover'); });
      span.addEventListener('dragleave', ()=> span.classList.remove('dragover'));
      span.addEventListener('drop', e => {
        e.preventDefault();
        span.classList.remove('dragover');
        const tok = e.dataTransfer.getData('text/plain');
        placeTokenInBlank(tok, span);
      });
      // click / keyboard to place selected token
      span.addEventListener('click', ()=> { if(selectedToken) placeTokenInBlank(selectedToken.val, span); });
      span.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); if(selectedToken) placeTokenInBlank(selectedToken.val, span); }});
      lineDiv.appendChild(span);
      last = re.lastIndex;
    }
    const rest = line.slice(last);
    if(rest) lineDiv.appendChild(document.createTextNode(rest));
    codeArea.appendChild(lineDiv);
  });
}

// --- place token into blank (tokens are reusable) ---
function placeTokenInBlank(tokenValue, blankEl){
  if(!blankEl) return;
  blankEl.dataset.token = tokenValue;
  blankEl.dataset.filled = 'true';
  blankEl.textContent = tokenValue;
  blankEl.classList.add('filled');
  // clear selection
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  selectedToken = null;
}

// --- reset puzzle (clears blanks, reshuffles bank) ---
function resetCurrent(){
  const p = puzzles[currentIndex];
  document.querySelectorAll('.blank').forEach(b=>{
    b.dataset.filled = 'false';
    b.dataset.token = '';
    b.classList.remove('filled','correct','incorrect');
    b.textContent = `___${b.dataset.blank}___`;
  });
  renderBank(p.bank.slice());
  msgEl.textContent = '';
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  selectedToken = null;
  // hide example on reset
  exampleBox.style.display = 'none'; exampleBox.setAttribute('aria-hidden','true'); toggleExample.textContent = 'Show example output';
  // teacher reveal state: do not auto-disable teacher buttons here beyond their existing logic
  updateTeacherButtons();
}

// --- check answers ---
function checkAnswers(){
  const p = puzzles[currentIndex];
  const answers = p.answers || [];
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  let allCorrect = true;
  blanks.forEach((b, i)=>{
    const placed = b.dataset.filled === 'true' ? b.dataset.token : '';
    const correct = answers[i] !== undefined ? String(answers[i]) : '';
    if(correct === '' || correct === undefined) {
      b.classList.remove('correct','incorrect');
      return;
    }
    const placedTrim = placed !== null ? placed.toString().trim() : '';
    const correctTrim = correct.toString().trim();
    if(placedTrim === correctTrim){
      b.classList.remove('incorrect'); b.classList.add('correct');
    } else {
      b.classList.remove('correct'); b.classList.add('incorrect');
      allCorrect = false;
    }
  });
  if(allCorrect){
    msgEl.textContent = 'All correct! Well done ðŸŽ‰'; msgEl.style.color = '#1a7f3a';
  } else {
    msgEl.textContent = 'Some blanks are incorrect â€” incorrect blanks are highlighted.'; msgEl.style.color = '#a00';
  }
}

// --- single-blank reveal hint (existing feature) ---
function revealOneBlank(){
  if(usedHintForPuzzle[currentIndex]) return;
  const p = puzzles[currentIndex];
  const answers = p.answers || [];
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  for(let i=0;i<blanks.length;i++){
    const b = blanks[i];
    const correct = answers[i] !== undefined ? String(answers[i]) : '';
    if(!correct) continue;
    const placed = b.dataset.filled === 'true' ? (b.dataset.token || '') : '';
    if(placed.trim() !== correct.trim()){
      b.dataset.token = correct;
      b.dataset.filled = 'true';
      b.textContent = correct;
      b.classList.remove('incorrect'); b.classList.add('correct');
      usedHintForPuzzle[currentIndex] = true;
      revealHintBtn.disabled = true; revealHintBtn.textContent = 'Reveal hint (used)'; revealHintBtn.style.opacity='0.6';
      msgEl.textContent = 'Hint used: one correct blank filled.'; msgEl.style.color='#0b5';
      return;
    }
  }
  // nothing to reveal
  usedHintForPuzzle[currentIndex] = true;
  revealHintBtn.disabled = true; revealHintBtn.textContent = 'Reveal hint (used)'; revealHintBtn.style.opacity='0.6';
  msgEl.textContent = 'No eligible blank found to reveal.'; msgEl.style.color='#a00';
}

// --- TEACHER AUTHENTICATION & REVEAL ALL ---
function teacherIsPasswordSet(){
  return !!localStorage.getItem(STORAGE_KEY);
}
function setTeacherPassword(pw){
  try {
    localStorage.setItem(STORAGE_KEY, pw);
    return true;
  } catch (e) {
    console.error('localStorage error', e);
    return false;
  }
}
function checkTeacherPassword(pw){
  const stored = localStorage.getItem(STORAGE_KEY);
  return stored !== null && pw === stored;
}
function authenticateTeacherFlow(callbackIfAuthenticated){
  // If no pw set, ask teacher to set one (with confirmation)
  if(!teacherIsPasswordSet()){
    const pw = prompt('No teacher password found. Enter a new password to protect teacher controls (leave blank to cancel):');
    if(!pw){ alert('Teacher password setup cancelled.'); return; }
    const pw2 = prompt('Confirm new password:');
    if(pw !== pw2){ alert('Passwords did not match. Setup cancelled.'); return; }
    const ok = setTeacherPassword(pw);
    if(!ok){ alert('Could not save password in localStorage (maybe blocked).'); return; }
    alert('Password saved. Keep it safe. Teacher controls are now protected.');
    teacherAuthenticated = true;
    teacherLogoutBtn.style.display = 'inline-block';
    if(callbackIfAuthenticated) callbackIfAuthenticated();
    updateTeacherButtons();
    return;
  }
  // Password exists: ask for it
  const pw = prompt('Enter teacher password (leave blank to cancel):');
  if(!pw){ return; }
  if(checkTeacherPassword(pw)){
    teacherAuthenticated = true;
    teacherLogoutBtn.style.display = 'inline-block';
    if(callbackIfAuthenticated) callbackIfAuthenticated();
    updateTeacherButtons();
  } else {
    alert('Incorrect password.');
  }
}

// Update teacher button states
function updateTeacherButtons(){
  // If not authenticated, show the reveal button but in auth-required state. If authenticated, label toggles depending on reveal state.
  if(!teacherAuthenticated){
    teacherRevealAllBtn.textContent = 'Teacher: Reveal all answers';
    teacherRevealAllBtn.disabled = false;
    teacherRevealAllBtn.style.opacity = '1';
    teacherLogoutBtn.style.display = 'none';
  } else {
    teacherLogoutBtn.style.display = 'inline-block';
    // if currently in teacher-revealed mode for this puzzle -> label "Hide answers", else "Teacher: Reveal all answers"
    const state = prevStateForReveal[currentIndex];
    if(state && state.revealed === true){
      teacherRevealAllBtn.textContent = 'Teacher: Hide answers';
      teacherRevealAllBtn.disabled = false;
      teacherRevealAllBtn.style.opacity = '1';
    } else {
      teacherRevealAllBtn.textContent = 'Teacher: Reveal all answers';
      teacherRevealAllBtn.disabled = false;
      teacherRevealAllBtn.style.opacity = '1';
    }
  }
}

// Save current blanks state (to restore when hiding teacher reveal)
function snapshotCurrentBlanks(){
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  const snapshot = blanks.map(b => ({ token: b.dataset.token || '', filled: b.dataset.filled === 'true' }));
  prevStateForReveal[currentIndex] = { snapshot, revealed: false };
}

// Restore blanks from snapshot
function restoreSnapshotForPuzzle(){
  const state = prevStateForReveal[currentIndex];
  if(!state || !state.snapshot) return;
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  state.snapshot.forEach((s,i)=>{
    const b = blanks[i];
    if(!b) return;
    if(s.filled){
      b.dataset.token = s.token;
      b.dataset.filled = 'true';
      b.textContent = s.token;
      b.classList.remove('incorrect'); b.classList.add('filled'); // don't mark correct/incorrect when restoring
    } else {
      b.dataset.token = '';
      b.dataset.filled = 'false';
      b.textContent = `___${b.dataset.blank}___`;
      b.classList.remove('filled','correct','incorrect');
    }
  });
}

// Reveal all answers (teacher only)
function teacherToggleRevealAll(){
  if(!teacherAuthenticated){
    authenticateTeacherFlow( () => {
      // once authed, immediately reveal
      teacherPerformRevealToggle();
    });
    return;
  }
  teacherPerformRevealToggle();
}
function teacherPerformRevealToggle(){
  const state = prevStateForReveal[currentIndex];
  if(state && state.revealed === true){
    // currently revealed -> hide (restore previous)
    restoreSnapshotForPuzzle();
    prevStateForReveal[currentIndex].revealed = false;
    msgEl.textContent = 'Teacher: answers hidden (restored previous state).';
    msgEl.style.color = '#444';
    updateTeacherButtons();
    return;
  }
  // not revealed: snapshot current then fill blanks with answers
  snapshotCurrentBlanks();
  const p = puzzles[currentIndex];
  const answers = p.answers || [];
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  blanks.forEach((b,i)=>{
    const correct = answers[i] !== undefined ? String(answers[i]) : '';
    if(!correct || correct === '') return;
    b.dataset.token = correct;
    b.dataset.filled = 'true';
    b.textContent = correct;
    b.classList.remove('incorrect'); b.classList.add('correct');
  });
  prevStateForReveal[currentIndex].revealed = true;
  msgEl.textContent = 'Teacher: all answers revealed for this puzzle.';
  msgEl.style.color = '#0b5';
  updateTeacherButtons();
}

// Teacher logout
function teacherLogout(){
  teacherAuthenticated = false;
  teacherLogoutBtn.style.display = 'none';
  msgEl.textContent = 'Teacher logged out.';
  msgEl.style.color = '#444';
  updateTeacherButtons();
}

// --- events wiring for UI ---
document.getElementById('submitBtn').addEventListener('click', checkAnswers);
document.getElementById('resetBtn').addEventListener('click', resetCurrent);
document.getElementById('nextBtn').addEventListener('click', ()=> {
  currentIndex = (currentIndex + 1) % puzzles.length;
  puzzleSelect.value = currentIndex;
  loadPuzzle(currentIndex);
});
puzzleSelect.addEventListener('change', (e)=> loadPuzzle(Number(e.target.value)));
revealHintBtn.addEventListener('click', revealOneBlank);
teacherRevealAllBtn.addEventListener('click', teacherToggleRevealAll);
teacherLogoutBtn.addEventListener('click', teacherLogout);

// --- Reveal hint button initial state logic ---
function updateRevealHintBtn(){
  if(usedHintForPuzzle[currentIndex]){
    revealHintBtn.disabled = true;
    revealHintBtn.textContent = 'Reveal hint (used)';
    revealHintBtn.style.opacity='0.6';
  } else {
    revealHintBtn.disabled = false;
    revealHintBtn.textContent = 'Reveal hint (fill one blank)';
    revealHintBtn.style.opacity='1';
  }
}

// --- load puzzle ---
function loadPuzzle(idx){
  if(idx < 0 || idx >= puzzles.length) idx = 0;
  currentIndex = idx;
  const p = puzzles[currentIndex];
  // render description
  renderDescription(p);
  renderCode(p);
  renderBank(p.bank.slice());
  msgEl.textContent = '';
  // reset selection
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  selectedToken = null;
  // reveal hint state
  updateRevealHintBtn();
  // teacher button reflect reveal state
  updateTeacherButtons();
  // hide example by default
  exampleBox.style.display = 'none'; exampleBox.setAttribute('aria-hidden','true'); toggleExample.textContent = 'Show example output';
}

// --- init ---
populatePuzzleSelect();
loadPuzzle(0);

</script>
</body>
</html>
