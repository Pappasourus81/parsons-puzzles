<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FOR Loops - Fill in the blanks</title>
<style>
  :root{
    --bg:#ffffff; --accent:#0066cc; --ok:#d4f7d9; --bad:#ffd6d6;
    --panel:#f8f9fb; --muted:#666; --token-border:#e0e6ef;
  }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; background:var(--bg); color:#111; }
  h1{ margin:0 0 12px 0; font-size:20px; }
  .meta{ color:#444; margin-bottom:12px; }
  .panel{ background:var(--panel); padding:12px; border-radius:10px; margin-bottom:12px; }
  .desc-box{ padding:10px; border-radius:8px; background:#fff; border:1px solid #d1d7df; margin-bottom:10px; white-space:normal; }
  .desc-bullets{ margin:6px 0 8px 18px; color:#222; }
  .hint{ margin-top:6px; font-style:italic; color:#374151; }
  .example-box{ margin-top:8px; padding:8px; background:#f7fbff; border:1px solid #d9eefc; border-radius:6px; font-family: "Courier New", monospace; color:#0b3b66; display:none; white-space:pre-line; }
  .code-area{ font-family: "Courier New", monospace; background:#fff; padding:10px; border-radius:8px; border:1px dashed #ccc; min-height:140px; }
  .code-line{ padding:6px 4px; white-space:pre-wrap; }
  .blank{ display:inline-flex; align-items:center; justify-content:center; min-width:56px; padding:4px 8px; margin:0 4px; background:#f2f6fb; border-radius:4px; border:1px dashed #9fb8e6; cursor:pointer; outline:none; color:#111; font-weight:600; }
  .blank.filled{ background:#fff; border-style:solid; border-color:var(--token-border); }
  .blank.correct{ background:var(--ok); border-color:#2a9a4a; }
  .blank.incorrect{ background:var(--bad); border-color:#c44; }
  .bank{ display:flex; flex-wrap:wrap; gap:8px; padding:10px; margin-top:10px; background:transparent; }
  .token{ background:#fff; border:1px solid var(--token-border); padding:6px 10px; border-radius:8px; cursor:grab; user-select:none; display:inline-flex; align-items:center; justify-content:center; min-width:40px; color:#111; font-weight:600; }
  .token[aria-pressed="true"]{ outline:3px solid rgba(0,102,204,0.18); box-shadow:0 2px 6px rgba(0,0,0,0.06); }
  .controls{ display:flex; gap:8px; margin-top:12px; align-items:center; }
  button.action{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  button.secondary{ background:#666; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  .small{ padding:6px 10px; font-size:13px; border-radius:6px; }
  #message{ margin-top:10px; font-weight:600; }
  .keyboard-hint{ color:var(--muted); font-size:13px; margin-top:6px; }
  @media (max-width:700px){ .bank{ gap:6px; } .blank{ min-width:44px; } .token{ min-width:32px; padding:6px 8px;} }
</style>
</head>
<body>
  <h1>FOR Loops - Fill in the blanks</h1>
  <div class="meta">Place the correct token into each blank. Use drag & drop, or keyboard: Tab to token â†’ Enter to pick â†’ Tab to blank â†’ Enter to place.</div>

  <div class="panel">
    <div id="desc" class="desc-box">
      <div id="descTitle" style="font-weight:700; margin-bottom:6px;">Select a puzzle to see its description</div>
      <ul id="descBullets" class="desc-bullets"></ul>
      <div id="teacherHint" class="hint"></div>
      <div style="margin-top:8px;">
        <button id="toggleExample" class="small">Show example output</button>
        <button id="revealHintBtn" class="small" style="margin-left:8px;">Reveal hint (3 left)</button>
      </div>
      <div id="exampleBox" class="example-box" role="region" aria-hidden="true"></div>
    </div>

    <div class="code-area" id="codeArea" aria-live="polite"></div>

    <div class="bank" id="bank" aria-label="token bank"></div>

    <div class="keyboard-hint">Tip: click a token to select it, then click a blank to place it.</div>

    <div class="controls">
      <button id="submitBtn" class="action">Submit</button>
      <button id="resetBtn" class="secondary">Reset (reshuffle)</button>
      <button id="nextBtn" class="action">Next Puzzle</button>
      <div style="margin-left:auto;">
        <label style="font-size:13px;color:#333">Puzzle:
          <select id="puzzleSelect" style="margin-left:8px; padding:6px; border-radius:6px;"></select>
        </label>
      </div>
    </div>

    <div id="message" role="status"></div>
  </div>

<script>
/* Student-facing version with 10 new puzzles derived from the PDF.
   Distractors increase from 2 to 11.
*/

const MAX_HINTS_PER_PUZZLE = 3;

const puzzles = [
  // 1. No input, simple loop with output (2 distractors)
  {
    title: "1. No input, simple loop with output",
    bullets: [
      "This algorithm declares a counter and prints numbers 1 through 5.",
      "The loop automatically counts from 1 to 5 and outputs each value."
    ],
    hint: "Use a FOR loop that starts at 1 and ends at 5, then close it with NEXT.",
    example: "Output:\n1\n2\n3\n4\n5",
    lines: [
      "DECLARE LoopCounter : INTEGER",
      "",
      "___1___ LoopCounter â† 1 ___2___ 5",
      "    OUTPUT LoopCounter",
      "___3___ LoopCounter"
    ],
    answers: ["FOR", "TO", "NEXT"],
    // 3 answers + 2 distractors = 5 tokens
    bank: ["FOR", "TO", "NEXT", "WHILE", "STEP"]
  },

  // 2. Input, loop with output (3 distractors)
  {
    title: "2. Input, loop with output",
    bullets: [
      "This algorithm asks the user for a number.",
      "It then prints the phrase \"Computer Science\" that many times."
    ],
    hint: "The number the user enters is used as the upper limit of the FOR loop.",
    example: "Input: 3\nOutput:\nComputer Science\nComputer Science\nComputer Science",
    lines: [
      "DECLARE Repetitions : ___1___",
      "DECLARE i : ___2___",
      "",
      "INPUT ___3___",
      "",
      "___4___ i â† 1 TO Repetitions",
      "    OUTPUT \"Computer Science\"",
      "___5___ ___6___"
    ],
    answers: ["INTEGER", "INTEGER", "Repetitions", "FOR", "NEXT", "i"],
    // 6 answers + 3 distractors = 9 tokens
    bank: ["INTEGER", "Repetitions", "FOR", "NEXT", "i", "STRING", "WHILE", "Count", "STEP"]
  },

  // 3. Input, loop with input, output outside loop (4 distractors)
  {
    title: "3. Input, loop with input, output outside loop",
    bullets: [
      "This algorithm asks how many items to process.",
      "It allows the user to input that many values.",
      "Only the final value entered (the last one) is output after the loop finishes."
    ],
    hint: "The loop counter and the number of items must match the original code logic.",
    example: "Input NumberOfItems: 3\nInputs: 10, 20, 30\nOutput:\nThe last item entered was 30",
    lines: [
      "DECLARE NumberOfItems : INTEGER",
      "DECLARE CurrentItem : INTEGER",
      "DECLARE Count : INTEGER",
      "",
      "INPUT ___1___",
      "",
      "FOR ___2___ â† 1 TO NumberOfItems",
      "    INPUT CurrentItem",
      "NEXT Count",
      "",
      "OUTPUT \"The last item entered was \", ___3___"
    ],
    answers: ["NumberOfItems", "Count", "CurrentItem"],
    // 3 answers + 4 distractors = 7 tokens
    bank: ["NumberOfItems", "Count", "CurrentItem", "Total", "Item", "i", "Repetitions"]
  },

  // 4. Input, loop, IF inside loop (5 distractors)
  {
    title: "4. Input, loop, IF inside loop",
    bullets: [
      "This algorithm inputs a maximum value.",
      "It prints all numbers from 1 up to that maximum, but only those greater than 10."
    ],
    hint: "Use INPUT for the maximum, a FOR loop from 1 to MaxValue, and an IF condition with > 10.",
    example: "Input MaxValue: 12\nOutput:\n11\n12",
    lines: [
      "DECLARE MaxValue : INTEGER",
      "DECLARE Counter : INTEGER",
      "",
      "___1___ ___2___",
      "",
      "FOR Counter â† 1 TO MaxValue",
      "    IF Counter ___3___ 10",
      "      ___4___",
      "        OUTPUT Counter",
      "    ___5___",
      "___6___ ___7___"
    ],
    answers: ["INPUT", "MaxValue", ">", "THEN", "ENDIF", "NEXT", "Counter"],
    // 7 answers + 5 distractors = 12 tokens
    bank: [
      "INPUT", "MaxValue", ">", "THEN", "ENDIF", "NEXT", "Counter",
      "<", "=", "Step", "Number", "Limit"
    ]
  },

  // 5. Input, loop, IF-ELSE inside loop (6 distractors)
  {
    title: "5. Input, loop, IF-ELSE inside loop",
    bullets: [
      "The user inputs a number of iterations.",
      "The loop checks if the current counter is even or odd using MOD.",
      "Even numbers print \"is Even\"; odd numbers print \"is Odd\"."
    ],
    hint: "FOR i â† 1 TO Iterations and an IF with MOD(i, 2) = 0 are the key parts.",
    example: "Input Iterations: 3\nOutput:\n1 is Odd\n2 is Even\n3 is Odd",
    lines: [
      "DECLARE Iterations : INTEGER",
      "DECLARE i : INTEGER",
      "",
      "INPUT Iterations",
      "",
      "___1___ i â† ___2___ TO ___3___",
      "    IF ___4___ = 0",
      "      THEN",
      "        OUTPUT i, \" is Even\"",
      "      ___5___",
      "        OUTPUT i, \" is Odd\"",
      "    ___6___",
      "NEXT i"
    ],
    answers: ["FOR", "1", "Iterations", "MOD(i, 2)", "ELSE", "ENDIF"],
    // 6 answers + 6 distractors = 12 tokens
    bank: [
      "FOR", "1", "Iterations", "MOD(i, 2)", "ELSE", "ENDIF",
      "DIV(i, 2)", "0", "i", "REPEAT", "UNTIL", "WHILE"
    ]
  },

  // 6. Input, loop, input inside loop, totalling (7 distractors)
  {
    title: "6. Input, loop, input inside loop, totalling",
    bullets: [
      "This algorithm calculates the sum of numbers entered by the user.",
      "The user first enters how many numbers will be input.",
      "Each number is added to a running total (Sum)."
    ],
    hint: "Initialise Sum to 0, loop from 1 to TotalNumbers, and add each NumberEntry to Sum.",
    example: "Input TotalNumbers: 3\nInputs: 5, 7, 8\nOutput:\nThe total sum is 20",
    lines: [
      "DECLARE TotalNumbers : INTEGER",
      "DECLARE NumberEntry : INTEGER",
      "DECLARE Sum : INTEGER",
      "DECLARE k : INTEGER",
      "",
      "Sum ___1___ ___2___",
      "INPUT ___3___",
      "",
      "___4___ k â† 1 TO ___5___",
      "    INPUT ___6___",
      "    Sum â† Sum + NumberEntry",
      "___7___ ___8___",
      "",
      "OUTPUT \"The total sum is \", ___9___"
    ],
    // From the blanks in the PDF:
    // Sum â† 0  -> "â†", "0"
    // INPUT TotalNumbers
    // FOR k â† 1 TO TotalNumbers
    // INPUT NumberEntry
    // NEXT k
    // OUTPUT ... Sum
    answers: ["â†", "0", "TotalNumbers", "FOR", "TotalNumbers", "NumberEntry", "NEXT", "k", "Sum"],
    // 9 answers + 7 distractors = 16 tokens
    bank: [
      "â†", "0", "TotalNumbers", "FOR", "NumberEntry", "NEXT", "k", "Sum",
      "1", "COUNT", "DIV", "MOD", "WHILE", "END", "OUTPUT", "INPUT"
    ]
  },

  // 7. Loop, totalling with IF-ELSE inside loop, output (8 distractors)
  {
    title: "7. Loop, totalling with IF-ELSE inside loop, output",
    bullets: [
      "This loops through a fixed range from 1 to 20.",
      "Numbers greater than 10 are added to HighTotal.",
      "Numbers less than or equal to 10 are added to LowTotal."
    ],
    hint: "Use HighTotal and LowTotal as separate running totals and an IF condition Number > 10.",
    example: "Output (for 1 to 20):\nSum of high numbers: 155\nSum of low numbers: 55",
    lines: [
      "DECLARE HighTotal : INTEGER",
      "DECLARE LowTotal : INTEGER",
      "DECLARE Number : INTEGER",
      "",
      "___1___ â† ___2___",
      "___3___ â† 0",
      "",
      "___4___ Number â† 1 TO ___5___",
      "    IF Number ___6___ ___7___",
      "      THEN",
      "        ___8___ â† HighTotal + ___9___",
      "      ELSE",
      "        LowTotal â† ___10___ + Number",
      "    ENDIF",
      "___11___ Number",
      "",
      "OUTPUT \"Sum of high numbers: \", ___12___",
      "OUTPUT \"Sum of low numbers: \", ___13___"
    ],
    // Mapping from original:
    // HighTotal â† 0
    // LowTotal â† 0
    // FOR Number â† 1 TO 20
    // IF Number > 10
    //   HighTotal â† HighTotal + Number
    //   LowTotal â† LowTotal + Number
    // NEXT Number
    // OUTPUT ... HighTotal
    // OUTPUT ... LowTotal
    answers: [
      "HighTotal", "0",
      "LowTotal",
      "FOR", "20",
      ">", "10",
      "HighTotal", "Number",
      "LowTotal",
      "NEXT",
      "HighTotal",
      "LowTotal"
    ],
    // 13 answers + 8 distractors = 21 tokens
    bank: [
      "HighTotal", "LowTotal", "0", "FOR", "20", ">", "10", "NEXT",
      "Number", "1", "<", "=", "COUNT", "Sum", "STEP", "LIMIT", "15", "OUTPUT", "INPUT", "THEN", "ENDIF"
    ]
  },

  // 8. Input, nested loop with output in inner loop (9 distractors)
  {
    title: "8. Input, nested loop with output in inner loop",
    bullets: [
      "This algorithm generates a grid of coordinates based on user input.",
      "The outer loop controls the row number, and the inner loop controls the column number.",
      "Each coordinate is printed as: Row r, Col c."
    ],
    hint: "Use r for rows and c for columns, with NEXT c inside and NEXT r outside.",
    example: "Input Rows: 2, Columns: 2\nOutput:\nRow 1 Col 1\nRow 1 Col 2\nRow 2 Col 1\nRow 2 Col 2",
    lines: [
      "DECLARE Rows : INTEGER",
      "DECLARE Columns : INTEGER",
      "DECLARE r : INTEGER",
      "DECLARE c : INTEGER",
      "",
      "INPUT Rows",
      "INPUT Columns",
      "",
      "FOR r â† 1 TO ___1___",
      "    FOR c â† 1 TO ___2___",
      "        OUTPUT \"Row \", ___3___, \" Col \", ___4___",
      "    NEXT ___5___",
      "NEXT ___6___"
    ],
    answers: ["Rows", "Columns", "r", "c", "c", "r"],
    // 6 answers + 9 distractors = 15 tokens
    bank: [
      "Rows", "Columns", "r", "c", "c", "r",
      "i", "j", "1", "0", "Row", "Col", "NEXT", "FOR", "STEP"
    ]
  },

  // 9. Input, nested loop, second loop inside IF statement (10 distractors)
  {
    title: "9. Input, nested loop, second loop inside IF statement",
    bullets: [
      "This algorithm inputs a limit and loops from 1 to that limit.",
      "Every time the current number is a multiple of 5, it prints a message.",
      "Then an inner loop prints \"***\" three times."
    ],
    hint: "Use MOD(OuterCount, 5) = 0 to detect multiples of 5, and an inner FOR loop for the asterisks.",
    example:
      "Input Limit: 5\nOutput:\n1\n2\n3\n4\n5\nMultiple of 5 found\n***\n***\n***",
    lines: [
      "DECLARE Limit : INTEGER",
      "DECLARE OuterCount : INTEGER",
      "DECLARE InnerCount : INTEGER",
      "",
      "INPUT Limit",
      "___1___ OuterCount â† 1 TO ___2___",
      "    OUTPUT OuterCount",
      "    IF ___3___ = 0",
      "      THEN",
      "        OUTPUT \"Multiple of 5 found\"",
      "        ___4___ InnerCount â† 1 TO 3",
      "            OUTPUT \"***\"",
      "        ___5___ InnerCount",
      "    ENDIF",
      "___6___ OuterCount"
    ],
    // From original code:
    // FOR OuterCount â† 1 TO Limit
    // IF MOD(OuterCount, 5) = 0
    //   FOR InnerCount â† 1 TO 3
    //   NEXT InnerCount
    // NEXT OuterCount
    answers: [
      "FOR",
      "Limit",
      "MOD(OuterCount, 5)",
      "FOR",
      "NEXT",
      "NEXT"
    ],
    // 6 answers + 10 distractors = 16 tokens
    bank: [
      "FOR", "Limit", "MOD(OuterCount, 5)", "NEXT",
      "WHILE", "REPEAT", "UNTIL", "OuterCount", "InnerCount",
      "3", "5", "DIV(OuterCount, 5)", "STEP", "COUNT", "0", "IF"
    ]
  },

  // 10. Input, loop, IF, loop inside IF, ELSE, with totalling, output outside loop (11 distractors)
  {
    title: "10. Input, loop, IF, loop inside IF, ELSE, with totalling, output outside loop",
    bullets: [
      "This complex algorithm calculates a score over several turns.",
      "If the turn number is even, it adds 10 points twice using an inner loop.",
      "If the turn number is odd, it subtracts 5 points once.",
      "At the end, it outputs the final total score."
    ],
    hint: "Use MOD(Turn, 2) = 0 to detect even turns, and a nested FOR loop to add the bonus.",
    example:
      "Input MaxTurns: 2\nTurn 1 (odd): Score -5\nTurn 2 (even): Score +20\nFinal calculated score: 15",
    lines: [
      "DECLARE MaxTurns : INTEGER",
      "DECLARE TotalScore : INTEGER",
      "DECLARE Turn : INTEGER",
      "DECLARE Bonus : INTEGER",
      "",
      "___1___ â† ___2___",
      "INPUT MaxTurns",
      "",
      "___3___ Turn â† 1 TO ___4___",
      "    IF ___5___ = 0",
      "      THEN",
      "        // Even turns get bonus points added in a loop",
      "        FOR ___6___ â† 1 TO 2",
      "            TotalScore â† ___7___ + ___8___",
      "        ___9___ Bonus",
      "      ___10___",
      "        // Odd turns lose points",
      "        ___11___ â† TotalScore - 5",
      "    ENDIF",
      "___12___ Turn",
      "",
      "OUTPUT \"Final calculated score: \", TotalScore"
    ],
    // From original code:
    // TotalScore â† 0
    // FOR Turn â† 1 TO MaxTurns
    // IF MOD(Turn, 2) = 0
    //   FOR Bonus â† 1 TO 2
    //       TotalScore â† TotalScore + 10
    //   NEXT Bonus
    // ELSE
    //   TotalScore â† TotalScore - 5
    // NEXT Turn
    answers: [
      "TotalScore", "0",
      "FOR", "MaxTurns",
      "MOD(Turn, 2)",
      "Bonus",
      "TotalScore", "10",
      "NEXT",
      "ELSE",
      "TotalScore",
      "NEXT"
    ],
    // 12 answers + 11 distractors = 23 tokens
    bank: [
      "TotalScore", "0", "FOR", "MaxTurns", "MOD(Turn, 2)", "Bonus",
      "10", "NEXT", "ELSE",
      "Turn", "2", "DIV(Turn, 2)", "STEP", "INPUT", "OUTPUT",
      "THEN", "ENDIF", "REPEAT", "UNTIL", "Score", "MOD(2, Turn)", "1", "5"
    ]
  }
];


// Elements
const bankEl = document.getElementById('bank');
const codeArea = document.getElementById('codeArea');
const descTitle = document.getElementById('descTitle');
const descBullets = document.getElementById('descBullets');
const teacherHint = document.getElementById('teacherHint');
const toggleExample = document.getElementById('toggleExample');
const revealHintBtn = document.getElementById('revealHintBtn');
const exampleBox = document.getElementById('exampleBox');
const msgEl = document.getElementById('message');
const puzzleSelect = document.getElementById('puzzleSelect');

let currentIndex = 0;
let selectedToken = null;
const usedHintsCount = {}; // in-memory per puzzle

// Helpers
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

function populatePuzzleSelect(){
  puzzleSelect.innerHTML = '';
  puzzles.forEach((p,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = p.title;
    puzzleSelect.appendChild(opt);
  });
  puzzleSelect.value = 0; // ensure the first puzzle is selected by default
}

// Render description & hint
function renderDescription(p){
  descTitle.textContent = p.title || '';
  descBullets.innerHTML = '';
  (p.bullets || []).forEach(b => {
    const li = document.createElement('li');
    li.textContent = b;
    descBullets.appendChild(li);
  });
  teacherHint.textContent = p.hint || '';
  if(p.example && p.example.trim().length > 0){
    toggleExample.style.display = 'inline-block';
    exampleBox.textContent = p.example;
    exampleBox.style.display = 'none';
    exampleBox.setAttribute('aria-hidden','true');
    toggleExample.textContent = 'Show example output';
  } else {
    toggleExample.style.display = 'none';
    exampleBox.style.display = 'none';
    exampleBox.setAttribute('aria-hidden','true');
  }
  updateRevealHintBtn();
}

// Example toggle
toggleExample.addEventListener('click', ()=>{
  const visible = exampleBox.style.display !== 'none';
  if(visible){
    exampleBox.style.display = 'none';
    exampleBox.setAttribute('aria-hidden','true');
    toggleExample.textContent = 'Show example output';
  } else {
    exampleBox.style.display = 'block';
    exampleBox.setAttribute('aria-hidden','false');
    toggleExample.textContent = 'Hide example output';
  }
});

// Render code area with blanks
function renderCode(puzzle){
  codeArea.innerHTML = '';
  puzzle.lines.forEach(line=>{
    const lineDiv = document.createElement('div');
    lineDiv.className = 'code-line';
    let last = 0;
    const re = /___(\d+)___/g;
    let m;
    while((m = re.exec(line)) !== null){
      const idx = m.index;
      const before = line.slice(last, idx);
      if(before) lineDiv.appendChild(document.createTextNode(before));
      const num = m[1];
      const span = document.createElement('button');
      span.type = 'button';
      span.className = 'blank';
      span.dataset.blank = num;
      span.dataset.filled = 'false';
      span.dataset.token = '';
      span.textContent = `___`;
      // drag/drop
      span.addEventListener('dragover', e => { e.preventDefault(); span.classList.add('dragover'); });
      span.addEventListener('dragleave', ()=> span.classList.remove('dragover'));
      span.addEventListener('drop', e => {
        e.preventDefault();
        span.classList.remove('dragover');
        const tok = e.dataTransfer.getData('text/plain');
        placeTokenInBlank(tok, span);
      });
      // click / keyboard
      span.addEventListener('click', ()=> { if(selectedToken) placeTokenInBlank(selectedToken.val, span); });
      span.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); if(selectedToken) placeTokenInBlank(selectedToken.val, span); }});
      lineDiv.appendChild(span);
      last = re.lastIndex;
    }
    const rest = line.slice(last);
    if(rest) lineDiv.appendChild(document.createTextNode(rest));
    codeArea.appendChild(lineDiv);
  });
}

// Render token bank
function renderBank(tokens){
  bankEl.innerHTML = '';
  const arr = tokens.slice();
  shuffleArray(arr);
  arr.forEach(tok=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'token';
    b.textContent = tok;
    b.setAttribute('aria-pressed','false');
    b.draggable = true;
    b.tabIndex = 0;
    b.addEventListener('click', ()=> toggleSelectToken(b, tok));
    b.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSelectToken(b,tok); }});
    b.addEventListener('dragstart', (e)=> e.dataTransfer.setData('text/plain', tok));
    bankEl.appendChild(b);
  });
}

function toggleSelectToken(el, val){
  if(selectedToken && selectedToken.el === el){
    el.setAttribute('aria-pressed','false'); selectedToken = null; return;
  }
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  el.setAttribute('aria-pressed','true');
  selectedToken = {el, val};
}

// Place token into blank â€” tokens are reusable
function placeTokenInBlank(tokenValue, blankEl){
  if(!blankEl) return;
  blankEl.dataset.token = tokenValue;
  blankEl.dataset.filled = 'true';
  blankEl.textContent = tokenValue;
  blankEl.classList.add('filled');
  // clear selection
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  selectedToken = null;
}

// Reset puzzle (clear blanks and reshuffle tokens)
function resetCurrent(){
  const p = puzzles[currentIndex];
  document.querySelectorAll('.blank').forEach(b=>{
    b.dataset.filled = 'false';
    b.dataset.token = '';
    b.classList.remove('filled','correct','incorrect');
    b.textContent = `___`;
  });
  renderBank(p.bank.slice());
  msgEl.textContent = '';
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  selectedToken = null;
  // keep used hint counts (intentional)
  updateRevealHintBtn();
  exampleBox.style.display = 'none'; exampleBox.setAttribute('aria-hidden','true'); toggleExample.textContent = 'Show example output';
}

// Check answers
function checkAnswers(){
  const p = puzzles[currentIndex];
  const answers = p.answers || [];
  // sort blanks by index (dataset.blank)
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  let allCorrect = true;
  
  // Note: answers array corresponds to blank indices 1, 2, 3...
  // blank index 1 -> answers[0]
  
  blanks.forEach((b, i)=>{
    const correct = answers[i] !== undefined ? String(answers[i]) : '';
    const placed = b.dataset.filled === 'true' ? b.dataset.token : '';
    
    if(correct === '' || correct === undefined) {
      b.classList.remove('correct','incorrect');
      return;
    }
    
    const placedTrim = placed !== null ? placed.toString().trim() : '';
    const correctTrim = correct.toString().trim();
    
    if(placedTrim === correctTrim){
      b.classList.remove('incorrect'); b.classList.add('correct');
    } else {
      b.classList.remove('correct'); b.classList.add('incorrect');
      allCorrect = false;
    }
  });
  
  if(allCorrect){
    msgEl.textContent = 'All correct! Well done ðŸŽ‰'; msgEl.style.color = '#1a7f3a';
  } else {
    msgEl.textContent = 'Some blanks are incorrect â€” incorrect blanks are highlighted.'; msgEl.style.color = '#a00';
  }
}

// Reveal a random eligible blank (up to MAX_HINTS_PER_PUZZLE)
function revealRandomBlank(){
  const used = usedHintsCount[currentIndex] || 0;
  if(used >= MAX_HINTS_PER_PUZZLE){
    msgEl.textContent = `No hints left for this puzzle (max ${MAX_HINTS_PER_PUZZLE}).`;
    msgEl.style.color = '#a00';
    updateRevealHintBtn();
    return;
  }
  const p = puzzles[currentIndex];
  const answers = p.answers || [];
  const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
  const eligible = [];
  
  blanks.forEach((b, i)=>{
    const correct = answers[i] !== undefined ? String(answers[i]) : '';
    if(!correct || correct.trim()==='') return;
    
    const placed = b.dataset.filled === 'true' ? (b.dataset.token || '') : '';
    if(placed.toString().trim() !== correct.toString().trim()){
      eligible.push(i);
    }
  });
  
  if(eligible.length === 0){
    msgEl.textContent = 'All blanks are already correct or there are no defined answers to reveal.';
    msgEl.style.color = '#444';
    return;
  }
  
  const randIdx = eligible[Math.floor(Math.random()*eligible.length)];
  const targetBlank = blanks[randIdx];
  const correctVal = answers[randIdx];
  
  targetBlank.dataset.token = correctVal;
  targetBlank.dataset.filled = 'true';
  targetBlank.textContent = correctVal;
  targetBlank.classList.remove('incorrect'); targetBlank.classList.add('correct');
  
  usedHintsCount[currentIndex] = used + 1;
  msgEl.textContent = `Hint used: a blank has been filled (${usedHintsCount[currentIndex]} of ${MAX_HINTS_PER_PUZZLE}).`;
  msgEl.style.color = '#0b5';
  updateRevealHintBtn();
}

// Update reveal button label
function updateRevealHintBtn(){
  const used = usedHintsCount[currentIndex] || 0;
  const left = Math.max(0, MAX_HINTS_PER_PUZZLE - used);
  if(left <= 0){
    revealHintBtn.disabled = true;
    revealHintBtn.textContent = `Reveal hint (used up)`;
    revealHintBtn.style.opacity = '0.6';
  } else {
    revealHintBtn.disabled = false;
    revealHintBtn.textContent = `Reveal hint (${left} left)`;
    revealHintBtn.style.opacity = '1';
  }
}

// Load puzzle
function loadPuzzle(idx){
  if(idx < 0 || idx >= puzzles.length) idx = 0;
  currentIndex = idx;
  const p = puzzles[currentIndex];
  
  renderDescription(p);
  renderCode(p);
  renderBank(p.bank.slice());
  
  msgEl.textContent = '';
  document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
  selectedToken = null;
  updateRevealHintBtn();
}

// Events
document.getElementById('submitBtn').addEventListener('click', checkAnswers);
document.getElementById('resetBtn').addEventListener('click', resetCurrent);
document.getElementById('nextBtn').addEventListener('click', ()=> {
  currentIndex = (currentIndex + 1) % puzzles.length;
  puzzleSelect.value = currentIndex;
  loadPuzzle(currentIndex);
});
puzzleSelect.addEventListener('change', (e)=> loadPuzzle(Number(e.target.value)));
revealHintBtn.addEventListener('click', revealRandomBlank);

// Init
populatePuzzleSelect();
loadPuzzle(0);
</script>
</body>
</html>
