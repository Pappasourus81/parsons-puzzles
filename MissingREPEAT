<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REPEAT UNTIL - Fill in the blanks</title>
  <style>
    :root{
      --bg:#ffffff;
      --accent:#0066cc;
      --ok:#d4f7d9;
      --bad:#ffd6d6;
      --panel:#f8f9fb;
      --muted:#666;
      --token-border:#e0e6ef;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:18px;
      background:var(--bg);
      color:#111;
    }
    h1{ margin:0 0 12px 0; font-size:20px; }
    .meta{ color:#444; margin-bottom:12px; }
    .panel{ background:var(--panel); padding:12px; border-radius:10px; margin-bottom:12px; }
    .desc-box{ padding:10px; border-radius:8px; background:#fff; border:1px solid #d1d7df; margin-bottom:10px; white-space:normal; }
    .desc-bullets{ margin:6px 0 8px 18px; color:#222; }
    .hint{ margin-top:6px; font-style:italic; color:#374151; }
    .example-box{ margin-top:8px; padding:8px; background:#f7fbff; border:1px solid #d9eefc; border-radius:6px; font-family: "Courier New", monospace; color:#0b3b66; display:none; white-space:pre-line; }
    .code-area{ font-family: "Courier New", monospace; background:#fff; padding:10px; border-radius:8px; border:1px dashed #ccc; min-height:160px; }
    .code-line{ padding:6px 4px; white-space:pre-wrap; }
    .blank{ display:inline-flex; align-items:center; justify-content:center; min-width:56px; padding:4px 8px; margin:0 4px; background:#f2f6fb; border-radius:4px; border:1px dashed #9fb8e6; cursor:pointer; outline:none; color:#111; font-weight:600; }
    .blank.filled{ background:#fff; border-style:solid; border-color:var(--token-border); }
    .blank.correct{ background:var(--ok); border-color:#2a9a4a; }
    .blank.incorrect{ background:var(--bad); border-color:#c44; }
    .bank{ display:flex; flex-wrap:wrap; gap:8px; padding:10px; margin-top:10px; background:transparent; }
    .token{ background:#fff; border:1px solid var(--token-border); padding:6px 10px; border-radius:8px; cursor:grab; user-select:none; display:inline-flex; align-items:center; justify-content:center; min-width:40px; color:#111; font-weight:600; }
    .token[aria-pressed="true"]{ outline:3px solid rgba(0,102,204,0.18); box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .controls{ display:flex; gap:8px; margin-top:12px; align-items:center; }
    button.action{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary{ background:#666; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .small{ padding:6px 10px; font-size:13px; border-radius:6px; }
    #message{ margin-top:10px; font-weight:600; }
    .keyboard-hint{ color:var(--muted); font-size:13px; margin-top:6px; }
    @media (max-width:700px){
      .bank{ gap:6px; }
      .blank{ min-width:44px; }
      .token{ min-width:32px; padding:6px 8px;}
    }
  </style>
</head>
<body>
  <h1>REPEAT UNTIL - Fill in the blanks</h1>

  <div class="meta">Place the correct token into each blank. Use drag & drop, or keyboard: Tab to token â†’ Enter to pick â†’ Tab to blank â†’ Enter to place.</div>

  <div class="panel">
    <div id="desc" class="desc-box">
      <div id="descTitle" style="font-weight:700; margin-bottom:6px;">Select a puzzle to see its description</div>
      <ul id="descBullets" class="desc-bullets"></ul>
      <div id="teacherHint" class="hint"></div>

      <div style="margin-top:8px;">
        <button id="toggleExample" class="small">Show example output</button>
        <button id="revealHintBtn" class="small" style="margin-left:8px;">Reveal hint (3 left)</button>
      </div>

      <div id="exampleBox" class="example-box" role="region" aria-hidden="true"></div>
    </div>

    <div class="code-area" id="codeArea" aria-live="polite"></div>

    <div class="bank" id="bank" aria-label="token bank"></div>

    <div class="keyboard-hint">Tip: click a token to select it, then click a blank to place it.</div>

    <div class="controls">
      <button id="submitBtn" class="action">Submit</button>
      <button id="resetBtn" class="secondary">Reset (reshuffle)</button>
      <button id="nextBtn" class="action">Next Puzzle</button>

      <div style="margin-left:auto;">
        <label style="font-size:13px;color:#333">Puzzle:
          <select id="puzzleSelect" style="margin-left:8px; padding:6px; border-radius:6px;"></select>
        </label>
      </div>
    </div>

    <div id="message" role="status"></div>
  </div>

  <script>
    /* Complete REPEAT UNTIL puzzle page
       - 10 puzzles using REPEAT ... UNTIL
       - Random reveal hint up to 3 per puzzle (in-session)
       - Reusable tokens, DnD + keyboard
    */

    const MAX_HINTS_PER_PUZZLE = 3;

    const puzzles = [
      // 1 Basic REPEAT UNTIL Output (warm-up)
      {
        title: "Basic REPEAT UNTIL Output",
        bullets: [
          "No input â€” use REPEAT UNTIL to print numbers 1 to 5.",
          "Each number should appear on its own line."
        ],
        hint: "Start i at 1; repeat OUTPUT i and increment i; stop when i > 5.",
        example: "1\n2\n3\n4\n5",
        lines: [
          "i = ___1___",
          "___2___",
          "OUTPUT i",
          "i = i + ___3___",
          "UNTIL i ___4___ ___5___"
        ],
        answers: ["1","REPEAT","1",">","5"],
        bank: ["REPEAT","UNTIL","i","1","2","3","4","5",">","+","OUTPUT"]
      },

      // 2 REPEAT UNTIL with Counter Variable 1..10
      {
        title: "REPEAT UNTIL with Counter Variable",
        bullets: [
          "No input â€” count from 1 to 10 using a REPEAT UNTIL loop.",
          "Use a counter variable that increases by 1 each time."
        ],
        hint: "Initialise counter to 1, increment by 1, stop when counter > 10.",
        example: "1\n2\n3\n4\n5\n6\n7\n8\n9\n10",
        lines: [
          "count = ___1___",
          "___2___",
          "OUTPUT count",
          "count = count + ___3___",
          "UNTIL count ___4___ ___5___"
        ],
        answers: ["1","REPEAT","1",">","10"],
        bank: ["REPEAT","UNTIL","count","1","10","+","OUTPUT",">"]
      },

      // 3 REPEAT UNTIL with Input (stop when user enters 0)
      {
        title: "REPEAT UNTIL with Input (stop on 0)",
        bullets: [
          "Prompt the user to enter numbers repeatedly.",
          "Stop the loop only when the user enters 0."
        ],
        hint: "Use a variable (n). REPEAT: INPUT n; UNTIL n = 0.",
        example: "If user enters 4,5,0 â†’ loop stops when 0 entered.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "___3___ ___4___ ___5___ ___6___"
        ],
        answers: ["REPEAT","n","UNTIL","n","=","0"],
        bank: ["REPEAT","UNTIL","INPUT","n","=","0","OUTPUT"]
      },

      // 4 REPEAT UNTIL with Input and Output (stop -1, output doubled)
      {
        title: "REPEAT UNTIL with Input and Output (stop on -1)",
        bullets: [
          "Prompt the user to enter numbers and output each number doubled.",
          "Stop when the user enters -1."
        ],
        hint: "REPEAT: INPUT val; if val is not equal to -1 PRINT val * 2; STOP when val = -1.",
        example: "Input 3 â†’ Output 6. Input -1 â†’ loop stops.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "IF ___3___ ___4___ ___5___ THEN",
          "OUTPUT ___6___ ___7___ ___8___",
          "ENDIF",
          "___9___ ___10___ ___11___ ___12___"
        ],
        answers: ["REPEAT","val","val","<>","-1","val","*","2","UNTIL","val","=","-1"],
        bank: ["REPEAT","UNTIL","val","INPUT","OUTPUT","<>","=","-1","*","2","IF","ENDIF"]
      },

      // 5 REPEAT UNTIL with Conditional Output (positive/negative; stop 0)
      {
        title: "REPEAT UNTIL with Conditional Output",
        bullets: [
          "Ask for a number repeatedly and print whether it is positive or negative.",
          "Stop when the user enters 0."
        ],
        hint: "After entering n, check if n is greater than 0, and  print \"Positive\" , otherwise print \"Negative\". Stop when n is equal to 0.",
        example: "Input 3 â†’ Positive. Input -2 â†’ Negative. Input 0 â†’ stops.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "IF ___3___ ___4___ ___5___ THEN",
          "OUTPUT \"Positive\"",
          "ELSE",
          "OUTPUT \"Negative\"",
          "ENDIF",
          "___6___ ___7___ ___8___ ___9___"
        ],
        answers: ["REPEAT","n","n",">","0","UNTIL","n","=","0"],
        bank: ["REPEAT","UNTIL","INPUT","n",">","0","IF","ELSE","OUTPUT","\"Positive\"","\"Negative\"","="]
      },

      // 6 REPEAT UNTIL with IFâ€“ELSE (age check, stop -1)
      {
        title: "REPEAT UNTIL with IFâ€“ELSE (age check)",
        bullets: [
          "Prompt the user for age repeatedly.",
          "If age is greater than or equal to 18 output 'Adult' otherwise 'Child'. Stop when the user enters -1."
        ],
        hint: "REPEAT: INPUT age; IF age >= 18 OUTPUT 'Adult' ELSE OUTPUT 'Child'; UNTIL age = -1.",
        example: "Input 20 â†’ Adult; input 12 â†’ Child; -1 â†’ stops.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "IF ___3___ ___4___ ___5___ THEN",
          "OUTPUT \"Adult\"",
          "ELSE",
          "OUTPUT \"Child\"",
          "ENDIF",
          "___6___ ___7___ ___8___ ___9___"
        ],
        answers: ["REPEAT","age","age",">=","18","UNTIL","age","=","-1"],
        bank: ["REPEAT","UNTIL","INPUT","age",">=","18","IF","ELSE","OUTPUT","\"Adult\"","\"Child\"","=","-1"]
      },

      // 7 REPEAT UNTIL Counting Condition (count scores >50; stop -1)
      {
        title: "REPEAT UNTIL Counting Condition",
        bullets: [
          "Ask the user to enter test scores repeatedly and count how many are above 50.",
          "Stop when the user enters -1; then output the count."
        ],
        hint: "Initialise count to 0; for each score > 50 increment count; stop when input = -1.",
        example: "Inputs 55,40,60,-1 â†’ Output: 2",
        lines: [
          "count = ___1___",
          "___2___",
          "INPUT ___3___",
          "IF ___3___ ___4___ ___5___",
          "count = count + ___6___",
          "ENDIF",
          "___7___ ___3___ ___8___ ___9___",
          "OUTPUT count"
        ],
        answers: ["0","REPEAT","score",">","50","1","UNTIL","score","=","-1"],
        bank: ["REPEAT","UNTIL","score","count","0","1",">","50","=","-1","INPUT","OUTPUT","IF","ENDIF","+"]
      },

      // 8 REPEAT UNTIL with Validation Check (password = "Secret")
      {
        title: "REPEAT UNTIL with Validation Check",
        bullets: [
          "Ask the user for a password repeatedly until the correct password 'Secret' is entered.",
          "When correct, output 'Access granted'."
        ],
        hint: "REPEAT: INPUT pw; UNTIL pw = \"Secret\". After loop OUTPUT 'Access granted'.",
        example: "Input 'x' â†’ repeats; input 'Secret' â†’ 'Access granted'.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "___3___ ___2___ ___4___ ___5___",
          "OUTPUT \"Access granted\""
        ],
        answers: ["REPEAT","pw","UNTIL","pw","=\"Secret\""],
        bank: ["REPEAT","UNTIL","INPUT","pw","=","\"Secret\"","OUTPUT","\"Access granted\""]
      },

      // 9 REPEAT UNTIL with Nested FOR Loop (ask # stars; stop 0)
      {
        title: "REPEAT UNTIL with Nested FOR Loop",
        bullets: [
          "Repeat asking how many stars to print. Use a FOR loop to print that many '*' characters.",
          "Stop when the user enters 0."
        ],
        hint: "REPEAT: INPUT n; FOR i = 1 TO n DO OUTPUT '*'; NEXT i; UNTIL n = 0.",
        example: "Input 3 â†’ prints ***. Input 0 â†’ stops.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "___3___ i = ___4___ TO ___5___ DO",
          "OUTPUT \"*\"",
          "NEXT i",
          "___6___ ___2___ ___7___ ___8___"
        ],
        answers: ["REPEAT","n","FOR","1","n","UNTIL","n","=","0"],
        bank: ["REPEAT","UNTIL","FOR","i","1","n","TO","DO","INPUT","OUTPUT","NEXT","=","0","\"*\""]
      },

      // 10 REPEAT UNTIL with FOR Loop and Conditional Statement (even numbers 1..N)
      {
        title: "REPEAT UNTIL with FOR Loop and Conditional Statement",
        bullets: [
          "Ask the user to enter a number N repeatedly. Inside the REPEAT loop use a FOR loop to go 1..N and OUTPUT only the even numbers.",
          "Stop when the user enters 0."
        ],
        hint: "Outer REPEAT asks for N; FOR i = 1 TO N DO IF i MOD 2 = 0 OUTPUT i; NEXT i; UNTIL N = 0.",
        example: "Input 5 â†’ outputs 2 and 4. Input 0 â†’ stops.",
        lines: [
          "___1___",
          "INPUT ___2___",
          "___3___ i = ___4___ TO ___5___ DO",
          "IF i ___6___ ___7___ ___8___",
          "OUTPUT i",
          "ENDIF",
          "NEXT i",
          "___9___ ___2___ ___10___ ___11___"
        ],
        answers: ["REPEAT","N","FOR","1","N","MOD","2","=","UNTIL","N","=","0"],
        bank: ["REPEAT","UNTIL","FOR","i","1","N","MOD","2","=","INPUT","OUTPUT","NEXT","IF","ENDIF","0"]
      }
    ];

    // DOM references
    const bankEl = document.getElementById('bank');
    const codeArea = document.getElementById('codeArea');
    const descTitle = document.getElementById('descTitle');
    const descBullets = document.getElementById('descBullets');
    const teacherHint = document.getElementById('teacherHint');
    const toggleExample = document.getElementById('toggleExample');
    const revealHintBtn = document.getElementById('revealHintBtn');
    const exampleBox = document.getElementById('exampleBox');
    const msgEl = document.getElementById('message');
    const puzzleSelect = document.getElementById('puzzleSelect');

    let currentIndex = 0;
    let selectedToken = null;
    const usedHintsCount = {}; // in-session per puzzle

    // Utilities
    function shuffleArray(a){
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
    }

    function populatePuzzleSelect(){
      puzzleSelect.innerHTML = '';
      puzzles.forEach((p,i)=>{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = (i+1) + '. ' + p.title;
        puzzleSelect.appendChild(opt);
      });
      puzzleSelect.value = 0;
    }

    // Render description and example
    function renderDescription(p){
      descTitle.textContent = p.title || '';
      descBullets.innerHTML = '';
      (p.bullets || []).forEach(b => {
        const li = document.createElement('li');
        li.textContent = b;
        descBullets.appendChild(li);
      });
      teacherHint.textContent = p.hint || '';
      if(p.example && p.example.trim().length > 0){
        toggleExample.style.display = 'inline-block';
        exampleBox.textContent = p.example;
        exampleBox.style.display = 'none';
        exampleBox.setAttribute('aria-hidden','true');
        toggleExample.textContent = 'Show example output';
      } else {
        toggleExample.style.display = 'none';
        exampleBox.style.display = 'none';
        exampleBox.setAttribute('aria-hidden','true');
      }
      updateRevealHintBtn();
    }

    // Example toggle
    toggleExample.addEventListener('click', ()=>{
      const visible = exampleBox.style.display !== 'none';
      if(visible){
        exampleBox.style.display = 'none';
        exampleBox.setAttribute('aria-hidden','true');
        toggleExample.textContent = 'Show example output';
      } else {
        exampleBox.style.display = 'block';
        exampleBox.setAttribute('aria-hidden','false');
        toggleExample.textContent = 'Hide example output';
      }
    });

    // Render code with blanks
    function renderCode(puzzle){
      codeArea.innerHTML = '';
      puzzle.lines.forEach(line=>{
        const lineDiv = document.createElement('div');
        lineDiv.className = 'code-line';
        let last = 0;
        const re = /___(\d+)___/g;
        let m;
        while((m = re.exec(line)) !== null){
          const idx = m.index;
          const before = line.slice(last, idx);
          if(before) lineDiv.appendChild(document.createTextNode(before));
          const num = m[1];
          const span = document.createElement('button');
          span.type = 'button';
          span.className = 'blank';
          span.dataset.blank = num;
          span.dataset.filled = 'false';
          span.dataset.token = '';
          span.textContent = '___' + num + '___';
          // drag & drop
          span.addEventListener('dragover', e => { e.preventDefault(); span.classList.add('dragover'); });
          span.addEventListener('dragleave', ()=> span.classList.remove('dragover'));
          span.addEventListener('drop', e => {
            e.preventDefault();
            span.classList.remove('dragover');
            const tok = e.dataTransfer.getData('text/plain');
            placeTokenInBlank(tok, span);
          });
          // click / keyboard
          span.addEventListener('click', ()=> {
            if(selectedToken) placeTokenInBlank(selectedToken.val, span);
          });
          span.addEventListener('keydown', (e)=> {
            if(e.key==='Enter' || e.key===' '){
              e.preventDefault();
              if(selectedToken) placeTokenInBlank(selectedToken.val, span);
            }
          });
          lineDiv.appendChild(span);
          last = re.lastIndex;
        }
        const rest = line.slice(last);
        if(rest) lineDiv.appendChild(document.createTextNode(rest));
        codeArea.appendChild(lineDiv);
      });
    }

    // Render token bank
    function renderBank(tokens){
      bankEl.innerHTML = '';
      const arr = tokens.slice();
      shuffleArray(arr);
      arr.forEach(tok=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'token';
        b.textContent = tok;
        b.setAttribute('aria-pressed','false');
        b.draggable = true;
        b.tabIndex = 0;
        b.addEventListener('click', ()=> toggleSelectToken(b, tok));
        b.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){
            e.preventDefault();
            toggleSelectToken(b,tok);
          }
        });
        b.addEventListener('dragstart', (e)=> e.dataTransfer.setData('text/plain', tok));
        bankEl.appendChild(b);
      });
    }

    // Select token (keyboard support)
    function toggleSelectToken(el, val){
      if(selectedToken && selectedToken.el === el){
        el.setAttribute('aria-pressed','false');
        selectedToken = null;
        return;
      }
      document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
      el.setAttribute('aria-pressed','true');
      selectedToken = {el, val};
    }

    // Place token into blank â€” tokens are reusable
    function placeTokenInBlank(tokenValue, blankEl){
      if(!blankEl) return;
      blankEl.dataset.token = tokenValue;
      blankEl.dataset.filled = 'true';
      blankEl.textContent = tokenValue;
      blankEl.classList.add('filled');
      // clear token selection
      document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
      selectedToken = null;
    }

    // Reset current puzzle (clear blanks, reshuffle bank)
    function resetCurrent(){
      const p = puzzles[currentIndex];
      document.querySelectorAll('.blank').forEach(b=>{
        b.dataset.filled = 'false';
        b.dataset.token = '';
        b.classList.remove('filled','correct','incorrect');
        b.textContent = '___' + b.dataset.blank + '___';
      });
      renderBank(p.bank.slice());
      msgEl.textContent = '';
      document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
      selectedToken = null;
      updateRevealHintBtn();
      exampleBox.style.display = 'none';
      exampleBox.setAttribute('aria-hidden','true');
      toggleExample.textContent = 'Show example output';
    }

    // Check answers
    function checkAnswers(){
      const p = puzzles[currentIndex];
      const answers = p.answers || [];
      const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
      let allCorrect = true;
      blanks.forEach((b, i)=>{
        const placed = b.dataset.filled === 'true' ? b.dataset.token : '';
        const correct = answers[i] !== undefined ? String(answers[i]) : '';
        if(correct === '' || correct === undefined) {
          b.classList.remove('correct','incorrect');
          // not checked
          return;
        }
        const placedTrim = placed !== null ? placed.toString().trim() : '';
        const correctTrim = correct.toString().trim();
        if(placedTrim === correctTrim){
          b.classList.remove('incorrect');
          b.classList.add('correct');
        } else {
          b.classList.remove('correct');
          b.classList.add('incorrect');
          allCorrect = false;
        }
      });

      if(allCorrect){
        msgEl.textContent = 'All correct! Well done ðŸŽ‰';
        msgEl.style.color = '#1a7f3a';
      } else {
        msgEl.textContent = 'Some blanks are incorrect â€” incorrect blanks are highlighted.';
        msgEl.style.color = '#a00';
      }
    }

    // Reveal a random eligible blank (up to MAX_HINTS_PER_PUZZLE)
    function revealRandomBlank(){
      const used = usedHintsCount[currentIndex] || 0;
      if(used >= MAX_HINTS_PER_PUZZLE){
        msgEl.textContent = 'No hints left for this puzzle (max ' + MAX_HINTS_PER_PUZZLE + ').';
        msgEl.style.color = '#a00';
        updateRevealHintBtn();
        return;
      }
      const p = puzzles[currentIndex];
      const answers = p.answers || [];
      const blanks = Array.from(document.querySelectorAll('.blank')).sort((a,b)=> Number(a.dataset.blank)-Number(b.dataset.blank));
      const eligible = [];
      blanks.forEach((b, i)=>{
        const correct = answers[i] !== undefined ? String(answers[i]) : '';
        if(!correct || correct.trim()==='') return;
        const placed = b.dataset.filled === 'true' ? (b.dataset.token || '') : '';
        if(placed.toString().trim() !== correct.toString().trim()){
          eligible.push(i);
        }
      });

      if(eligible.length === 0){
        msgEl.textContent = 'All blanks are already correct or there are no defined answers to reveal.';
        msgEl.style.color = '#444';
        return;
      }

      const randIdx = eligible[Math.floor(Math.random()*eligible.length)];
      const targetBlank = blanks[randIdx];
      const correctVal = answers[randIdx];

      targetBlank.dataset.token = correctVal;
      targetBlank.dataset.filled = 'true';
      targetBlank.textContent = correctVal;
      targetBlank.classList.remove('incorrect');
      targetBlank.classList.add('correct');

      usedHintsCount[currentIndex] = used + 1;
      msgEl.textContent = 'Hint used: a blank has been filled (' + usedHintsCount[currentIndex] + ' of ' + MAX_HINTS_PER_PUZZLE + ').';
      msgEl.style.color = '#0b5';
      updateRevealHintBtn();
    }

    // Update reveal button label and state
    function updateRevealHintBtn(){
      const used = usedHintsCount[currentIndex] || 0;
      const left = Math.max(0, MAX_HINTS_PER_PUZZLE - used);
      if(left <= 0){
        revealHintBtn.disabled = true;
        revealHintBtn.textContent = 'Reveal hint (used up)';
        revealHintBtn.style.opacity = '0.6';
      } else {
        revealHintBtn.disabled = false;
        revealHintBtn.textContent = 'Reveal hint (' + left + ' left)';
        revealHintBtn.style.opacity = '1';
      }
    }

    // Load puzzle by index
    function loadPuzzle(idx){
      if(idx < 0 || idx >= puzzles.length) idx = 0;
      currentIndex = idx;
      const p = puzzles[currentIndex];

      // render description
      descTitle.textContent = p.title || '';
      descBullets.innerHTML = '';
      (p.bullets || []).forEach(b => {
        const li = document.createElement('li');
        li.textContent = b;
        descBullets.appendChild(li);
      });
      teacherHint.textContent = p.hint || '';
      if(p.example && p.example.trim().length > 0){
        toggleExample.style.display = 'inline-block';
        exampleBox.textContent = p.example;
        exampleBox.style.display = 'none';
        exampleBox.setAttribute('aria-hidden','true');
        toggleExample.textContent = 'Show example output';
      } else {
        toggleExample.style.display = 'none';
        exampleBox.style.display = 'none';
        exampleBox.setAttribute('aria-hidden','true');
      }

      // render code & bank
      renderCode(p);
      renderBank(p.bank.slice());
      msgEl.textContent = '';
      document.querySelectorAll('.token[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
      selectedToken = null;
      updateRevealHintBtn();
      exampleBox.style.display = 'none';
      exampleBox.setAttribute('aria-hidden','true');
      toggleExample.textContent = 'Show example output';
    }

    // Events wiring
    document.getElementById('submitBtn').addEventListener('click', checkAnswers);
    document.getElementById('resetBtn').addEventListener('click', resetCurrent);
    document.getElementById('nextBtn').addEventListener('click', ()=> {
      currentIndex = (currentIndex + 1) % puzzles.length;
      puzzleSelect.value = currentIndex;
      loadPuzzle(currentIndex);
    });
    puzzleSelect.addEventListener('change', (e)=> loadPuzzle(Number(e.target.value)));
    revealHintBtn.addEventListener('click', revealRandomBlank);

    // Init
    populatePuzzleSelect();
    loadPuzzle(0);
  </script>
</body>
</html>
